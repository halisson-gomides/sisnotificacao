{% extends "base.html" %}

{% block title %}Monitor - Notifica√ß√£o{% endblock %}

{% block content %}
<div class="container mx-auto p-4 max-w-md">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">
            üì± Monitor Infantil
        </h1>
        
        <form id="notification-form" 
              hx-post="/api/send-notification" 
              hx-target="#response"
              class="space-y-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    C√≥digo da Crian√ßa:
                </label>
                <input type="text" 
                       name="child_code" 
                       required
                       class="w-full px-3 py-3 border border-gray-300 rounded-lg text-lg text-center"
                       maxlength="20">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Prioridade:
                </label>
                <select name="priority" class="w-full px-3 py-3 border border-gray-300 rounded-lg">
                    <option value="normal" selected>üü¢ Normal</option>
                    <option value="urgente">üî¥ Urgente</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Mensagem (opcional):
                </label>
                <textarea name="message" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows="3"
                          placeholder="Informa√ß√£o adicional..."></textarea>
            </div>
            
            <button type="submit" 
                    class="w-full bg-blue-600 text-white py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition">
                üì¢ Enviar Notifica√ß√£o
            </button>
        </form>
        
        <div id="response" class="mt-4"></div>
        
        <!-- Status de notifica√ß√µes enviadas -->
        <div id="sent-notifications" class="mt-6">
            <h3 class="font-semibold mb-2">Notifica√ß√µes Enviadas:</h3>
            <div id="notifications-list" class="space-y-2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // WebSocket connection para monitors
    const ws = new WebSocket(`ws://${window.location.host}/ws/monitor`);
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.type === 'notification_sent') {
            addSentNotification(data.notification_id, data.child_code, 'pending');
        } else if (data.type === 'notification_viewed') {
            updateNotificationStatus(data.notification_id, 'viewed');
        }
    };
    
    function addSentNotification(id, code, status) {
        const listElement = document.getElementById('notifications-list');
        const notificationElement = document.createElement('div');
        notificationElement.id = `notification-${id}`;
        notificationElement.className = `p-3 rounded border-l-4 ${
            status === 'viewed' ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'
        }`;
        
        notificationElement.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-medium">C√≥digo: ${code}</span>
                <span class="text-sm ${
                    status === 'viewed' ? 'text-green-600' : 'text-yellow-600'
                }">
                    ${status === 'viewed' ? '‚úÖ Visualizado' : '‚è≥ Pendente'}
                </span>
            </div>
        `;
        
        listElement.insertBefore(notificationElement, listElement.firstChild);
    }
    
    function updateNotificationStatus(id, status) {
        const element = document.getElementById(`notification-${id}`);
        if (element) {
            element.className = 'p-3 rounded border-l-4 border-green-500 bg-green-50';
            element.querySelector('span:last-child').innerHTML = '‚úÖ Visualizado';
            element.querySelector('span:last-child').className = 'text-sm text-green-600';
        }
    }
    
    // Reset form after submission
    document.getElementById('notification-form').addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful) {
            this.reset();
            document.getElementById('response').innerHTML = 
                '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">‚úÖ Notifica√ß√£o enviada com sucesso!</div>';
            
            setTimeout(() => {
                document.getElementById('response').innerHTML = '';
            }, 3000);
        }
    });
</script>
{% endblock %}